{% if node.override.create.enabled %}
	
	{{ node.override.create.script }}

{% elif node.materializationType == 'table' %}

{% elif node.materializationType == 'view' %}
    {{ stage('Create Stage View') }}

    CREATE OR REPLACE VIEW {{ ref_no_link(node.location.name, node.name) }}
    (
        {% for col in columns %}
            {%- if col.is_rsrc_column -%}
                "{{datavault4coalesce.config.rsrc_alias}}"
            {%- elif col.is_ldts_column -%}
                "{{datavault4coalesce.config.ldts_alias}}"
            {% else %}
                "{{ col.name }}"
            {% endif %}
            {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
            {%- if not loop.last -%}, {% endif %}
        {% endfor %}

    )
    {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}
    AS
    {% for source in sources %}
        SELECT
        {% for col in source.columns %}
            {% if col.hashDetails %}
                {{ datavault4coalesce__hash(columns=col.hashDetails.columns, datatype=col.dataType, algo=col.hashDetails.algorithm) }} AS "{{ col.name }}"
            {% else %}
                {{ get_source_transform(col) }} AS "{{ col.name }}"
            {% endif %}
            {%- if not loop.last -%}, {% endif %}
        {% endfor %}

        {{ source.join }}

        {% if not loop.last %}
            {% if config.insertStrategy in ['UNION', 'UNION ALL'] %}
                {{ config.insertStrategy }}
            {% else %}
                UNION
            {% endif %}
        {% endif %}

        {%- if config.generate_ghost_records -%}

            UNION ALL 

            SELECT

            {% for source in sources %}
                {% for col in source.columns %}
                    {%- if "hashDetails" in col.keys() %}
                        {{ datavault4coalesce__ghost_record_per_datatype(col.name, col.dataType, 'unknown', hash=true, hash_algo=col.hashDetails.algorithm) }}
                    {%- else -%}
                        {{ datavault4coalesce__ghost_record_per_datatype(col.name, col.dataType, 'unknown', hash=false) }}
                    {%- endif -%}
                {% if not loop.last %},{% endif %}
                {% endfor %}
            {% endfor %}

            UNION ALL 

            SELECT

            {% for source in sources %}
                {% for col in source.columns %}
                    {%- if "hashDetails" in col.keys() %}
                        {{ datavault4coalesce__ghost_record_per_datatype(col.name, col.dataType, 'error', hash=true, hash_algo=col.hashDetails.algorithm) }}
                    {%- else -%}
                        {{ datavault4coalesce__ghost_record_per_datatype(col.name, col.dataType, 'error', hash=false) }}
                    {%- endif -%}
                {% if not loop.last %},{% endif %}
                {% endfor %}
            {% endfor %}

        {%- endif -%}

    {% endfor %}

{% endif %}